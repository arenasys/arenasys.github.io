<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="assets/css/photoswipe.css">
    
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <title>qDiffusion Web</title>
  </head>
  <body>

    <div class="modal fade" id="error-modal" tabindex="-1" role="dialog" aria-labelledby="error-model-title" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h6 class="modal-title" id="error-model-title">Error</h5>
          </div>
          <div class="modal-body" id="error-label">
            ...
          </div>
        </div>
      </div>
    </div>

    <div class="base-container">
      <div class="outputs">
        <div class="mid structure">
          <div class="mid-lower structure">
            <div class="button-holder">
              <button type="button" class="btn btn-gen" id="generate" disabled>
                Generate
              </button>
              <button type="button" class="btn btn-gen btn-forever" id="forever">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                  <rect x="0" y="0" width="24" height="24" fill="none" stroke="none"/>
                  <path fill="currentColor" d="M17 17H7v-3l-4 4l4 4v-3h12v-6h-2M7 7h10v3l4-4l-4-4v3H5v6h2V7Z"/>
                </svg>
              </button>
            </div>
            <div class="image-holder" id="gallery">
              <svg class="placeholder" version="1.1" width="64" height="64" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" fill="currentColor" >
                <path d="m239.97 128a15.79 15.79 0 0 1-10.5 15l-63.44 23.07-23.06 63.43a16 16 0 0 1-30 0l-23.07-63.5-63.43-23a16 16 0 0 1 0-30l63.5-23.07 23-63.43a16 16 0 0 1 30 0l23.07 63.5 63.43 23a15.79 15.79 0 0 1 10.5 15z"/>
              </svg>
              <img class="image" id="result" src="">
            </div>
            <div class="status-bar status-error" id="status-bar">
              <div class="progress status-progress">
                <div class="progress-bar" id="status-progress" role="progressbar" style="width: 0%;"></div>
              </div>
              <div class="status-text" id="status-text">Disconnected</div>
            </div>
          </div>
        </div>
      </div>
      <div class="parameters">
        <div class="column structure">
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend prompt-tab-row">
              <span class="input-group-text custom-tab" id="prompt-button" onclick="switchPrompt(true);">Prompt</span>
              <span style="width:2px"></span>
              <span class="input-group-text custom-tab disabled" id="negative-prompt-button" onclick="switchPrompt(false);">Negative</span>
            </div>
            <textarea class="prompt" placeholder="Prompt..." id="prompt"></textarea>
            <textarea class="prompt hidden" placeholder="Negative Prompt..." id="negative-prompt"></textarea>
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Model</span>
            </div>
            <select class="custom-select" id="model">
              <option selected>None</option>
            </select>
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Resolution</span>
            </div>
            <select class="custom-select" id="resolution">
              <option selected>512x512</option>
              <option value="1">512x640</option>
              <option value="2">640x512</option>
              <option value="3">640x640</option>
              <option value="4">640x768</option>
              <option value="5">768x640</option>
              <option value="6">768x768</option>
              <option value="7">768x960</option>
              <option value="8">960x768</option>
              <option value="9">960x960</option>

            </select>
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Steps</span>
            </div>
            <div class="form-control">
              <input class="form-control custom-range" id="steps" oninput="syncLabels();" type="range" value="25" min="10" max="50">
            </div>
            <div class="input-group-append">
              <span class="input-group-text text-fixed" id="steps-label">25</span>
            </div>
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Scale</span>
            </div>
            <div class="form-control">
              <input class="form-control custom-range" id="scale" oninput="syncLabels();" type="range" value="7" min="5" max="15">
            </div>
            <div class="input-group-append">
              <span class="input-group-text text-fixed" id="scale-label">7</span>
            </div>
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Seed</span>
            </div>
            <input type="number" class="form-control custom-input" id="seed" value="" placeholder="Random">
            <div class="input-group-append">
              <button type="button" class="btn btn-outline-secondary inline-button" id="randomize" onclick="randomizeSeed();">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dice-3-fill" viewBox="0 0 16 16">
                  <path d="M3 0a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V3a3 3 0 0 0-3-3H3zm2.5 4a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm8 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zM8 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Sampler</span>
            </div>
            <select class="custom-select" id="sampler">
              <option selected>Euler a</option>
              <option>DDIM</option>
              <option>DPM++ 2M</option>
              <option>DPM++ SDE</option>
            </select>
          </div>
        </div>
        <div class="column structure endpoint">
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Endpoint</span>
            </div>
            <input type="text" class="form-control custom-input" id="endpoint" placeholder="wss://endpoint.here">
          </div>
          <div class="input-group input-group-sm mb-2">
            <div class="input-group-prepend">
              <span class="input-group-text">Password</span>
            </div>
            <input type="text" class="form-control custom-input" id="password" placeholder="None">
            <div class="input-group-append">
              <button type="button" class="btn btn-outline-secondary inline-button" id="connect">
                <svg id="icon-disconnected" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 26 26"><path fill="currentColor" d="M24.875 0a1 1 0 0 0-.594.281l-1.656 1.656c-2.204-1.59-5.261-1.305-7.313.657c0 .076-.855.91-1.624 1.656l-.97-.969a1 1 0 0 0-.812-.312a1 1 0 0 0-.125.031a1 1 0 0 0-.5 1.719L13.562 7l-3.28 3.281a1.016 1.016 0 1 0 1.437 1.438L15 8.438L17.563 11l-3.282 3.281a1.016 1.016 0 1 0 1.438 1.438L19 12.438l2.281 2.28a1.016 1.016 0 1 0 1.438-1.437l-.969-.969l1.656-1.624c1.96-1.96 2.159-5.008.625-7.282L25.72 1.72A1 1 0 0 0 24.875 0zM3.906 10.969a1 1 0 0 0-.125.031a1 1 0 0 0-.5 1.719l.969.969l-1.656 1.624c-1.96 1.96-2.159 5.008-.625 7.282L.28 24.28a1.016 1.016 0 1 0 1.44 1.44l1.656-1.657c2.204 1.592 5.261 1.306 7.313-.656c0-.076.855-.91 1.624-1.656l.97.969a1.016 1.016 0 1 0 1.437-1.438l-10-10a1 1 0 0 0-.813-.312z"/></svg>
                <svg id="icon-connected" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 26 26"><path fill="currentColor" d="M24.875 0a1 1 0 0 0-.594.281l-4.656 4.657c-2.204-1.592-5.261-1.306-7.313.656c0 .076-.855.91-1.624 1.656l-.97-.969A1 1 0 0 0 8.782 6a1 1 0 0 0-.5 1.719l10 10a1.016 1.016 0 1 0 1.438-1.438l-.969-.968l1.656-1.626c1.96-1.96 2.159-5.007.625-7.28l4.688-4.688A1 1 0 0 0 24.875 0zM6.906 7.969A1 1 0 0 0 6.781 8a1 1 0 0 0-.5 1.719l.969.969l-1.656 1.624c-1.96 1.96-2.159 5.008-.625 7.282L.28 24.28a1.016 1.016 0 1 0 1.44 1.44l4.656-4.657c2.204 1.592 5.261 1.306 7.313-.656c0-.076.855-.91 1.624-1.656l.97.969a1.016 1.016 0 1 0 1.437-1.438l-10-10a1 1 0 0 0-.813-.312z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>

    function switchPrompt(value) {
      if(value) {
        $("#prompt-button").removeClass("disabled");
        $("#negative-prompt-button").addClass("disabled");
        $("#prompt").removeClass("hidden");
        $("#negative-prompt").addClass("hidden");
      } else {
        $("#prompt-button").addClass("disabled");
        $("#negative-prompt-button").removeClass("disabled");
        $("#prompt").addClass("hidden");
        $("#negative-prompt").removeClass("hidden");
      }
    }

    function syncLabels() {
      $("#steps-label").text($("#steps").val())
      $("#scale-label").text($("#scale").val())
    }

    function randomizeSeed() {
      $("#seed").val("");
    }

  </script>
  <script type="module">
    import PhotoSwipe from './assets/js/photoswipe.esm.min.js';
    import { getKey, encrypt, decrypt } from './assets/js/scheme.mjs';

    var ws
    var key

    var models

    var results = []
    var gallery

    var working = false
    var preview = false
    var forever = false
    var id

    function switchConnected(value) {
      if(value) {
        $("#icon-connected").removeClass("hidden");
        $("#icon-disconnected").addClass("hidden");
        $("#generate").prop("disabled", false);
        setStatusProgress(0);
        setStatusMode("idle");
        setStatusMessage("Connected");
      } else {
        $("#icon-connected").addClass("hidden");
        $("#icon-disconnected").removeClass("hidden");
        $("#generate").prop("disabled", true);
        setModels(["None"])
        setStatusProgress(0);
        setStatusMode("error")
        setStatusMessage("Disconnected")
      }
    }

    function switchWorking(value) {
      working = value

      if(!working && preview) {
        if(results.length != 0) {
          $("#result").attr("src", results[0].src)
        } else {
          $("#result").attr("src", "")
        }
      }

      if(working) {
        $("#generate").html("Working");
      } else {
        $("#generate").html("Generate");
      }

      console.log(value)
    }

    function glow(id, type) {
      $(id).addClass(type);
      setTimeout(function() {
        $(id).removeClass(type);
      },1000);
    }

    async function setModels(models) {
      var current = $("#model option:selected").text()
      $('#model option').remove();
      $.each(models, function(val, text) {
        var entry = $('<option></option>').val(val).html(text)
        if(text == current) {
          entry.prop('selected', true);
        }
        $("#model").append(entry);
      });
    }

    function setStatusMessage(message) {
      $("#status-text").text(message);
    }

    function setStatusMode(mode) {
      $("#status-bar").removeClass("status-error");
      $("#status-bar").removeClass("status-idle");
      $("#status-bar").removeClass("status-working");
      $("#status-bar").removeClass("status-empty");
      $("#status-bar").removeClass("status-waiting");
      $("#status-bar").addClass("status-"+mode);
    }

    function setStatusProgress(progress) {
      setStatusMode("empty")
      $("#status-progress").css("width", progress + "%");
    }


    function showError(title, error) {
      $("#error-label").html(error);
      $("#error-model-title").html(title);
      $("#error-modal").modal("show");
    }

    function setErrorMessage(message) {
      var stage = $("#status-text").text()
      setStatusProgress(0);
      setStatusMode("error")
      setStatusMessage("Errored")
      showError("Error while " + stage, message)
    }

    async function sendMessage(msg) {
      if(!msg.id) {
        msg.id = Math.floor(Math.random() * 1000000) + 1
      }
      ws.send(await encrypt(key, msg));
    }
    
    async function handleMessage(msg) {
      const type = msg.type;
      const data = msg.data;

      switch(type) {
        case "hello":
          sendMessage({"type":"options"})
          break;
        case "ack":
          if(data.queue > 0 && data.id == id) {
            setStatusMode("waiting")
            setStatusMessage("Waiting");
          }
          break;
        case "options":
          handleOptions(data)
          break;
        case "result":
          handleResult(data.images[0].buffer);
          preview = false;
          switchWorking(false);
          switchConnected(true);
          if(forever) {
            await doGenerate()
          }
          break;
        case "progress":
          setStatusProgress(Math.floor(100*(data.current+1)/data.total))
          if(data.previews) {
            preview = true;
            setResult(data.previews[0].buffer);
          }
          break;
        case "status":
          setStatusMode("working")
          setStatusMessage(data.message);
          break;
        case "error":
          setErrorMessage(data.message);
          break;
        case "aborted":
          switchWorking(false);
          switchConnected(true);
          break;
        default:
          console.log(msg)
      }
    }

    async function handleOptions(data) {
      models = {}
      $.map(data.UNET, function(entry) {
          var name = entry.split("/").slice(-1)[0].split("\\").slice(-1)[0];
          models[name] = entry;
      })
      await setModels(Object.keys(models));
    }

    function setResult(data) {
      var blob = new Blob([data], {'type': 'image/png'});
      var url = URL.createObjectURL(blob);
      $("#result").attr("src", url);
    }

    async function handlePreview(data) {
      var blob = new Blob([result.buffer], {'type': 'image/png'});
      var url = URL.createObjectURL(blob);
      $("#result").attr("src", url);
    }

    async function handleResult(data) {
      var blob = new Blob([data], {'type': 'image/png'});
      var url = URL.createObjectURL(blob);
      $("#result").on("load", function (event) {
        const i = $("#result");
        i.off("load");
        results.unshift({
          src: i.attr("src"),
          width: i.prop("naturalWidth"),
          height: i.prop("naturalHeight")
        });
        if(gallery) {
          gallery.options.dataSource = results;
          var c = gallery.currSlide.index;
          if(c != 0) {
            gallery.refreshSlideContent(c+1);
            gallery.goTo(c+1);
          }
          for (let x = 0; x < results.length; x++) {
            gallery.refreshSlideContent(x);
          }
        }
      })
      $("#result").attr("src", url);
    }

    function doConnect() {
      if(ws != undefined && ws.readyState != 3) {
        ws.close()
        return
      }
      try {
        ws = new WebSocket($("#endpoint").val());
      } catch(error) {
        showError("Invalid Endpoint");
        return
      }
      return new Promise((resolve, reject) => {
        ws.onopen = async function() {
          switchConnected(true);
          glow("#connect", "glow-success")
          key = undefined;
          resolve();
        };

        ws.onerror = async function(event) {
          console.log(event)
          glow("#connect", "glow-failed")
        }

        ws.onclose = async function() {
          switchConnected(false);
          key = undefined;
          reject();
        };

        ws.onmessage = async function(event) {
          if(key == undefined) {
            var password = $("#password").val();
            if(!password) {
              password = "qDiffusion";
            }
            key = await getKey(password);
          }

          if (event.data instanceof Blob) {
            try {
              const msg = await decrypt(key, await event.data.arrayBuffer());
              handleMessage(msg)
            } catch(error) {
              console.log(error, key)
              showError("Incorrect password");
            }
          }
        };
      });
    }

    async function doGenerate() {
      if(ws == undefined || ws.readyState != 1) {
        glow("#generate", "glow-failed")
        return
      }
      
      if(working) {
        request = {
          "type": "cancel",
          "data": {
            "id": id
          }
        }
        await sendMessage(request);
        return;
      }

      var resolution = $("#resolution option:selected").text().split("x")
      var seed = $("#seed").val()
      if(seed == "") {
        seed = "-1"
      }
      var model = models[$("#model option:selected").text()]

      var request = {
        "type": "txt2img",
        "data": {
          "width": parseInt(resolution[0]),
          "height": parseInt(resolution[1]),
          "steps": parseInt($("#steps").val()),
          "scale": parseFloat($("#scale").val()),
          "seed": parseInt(seed),
          "sampler": $("#sampler option:selected").text(),
          "prompt": [[[$("#prompt").val()], [$("#negative-prompt").val()]]],
          "clip_skip": 1,
          "batch_size": 1,
          "unet": model,
          "clip": model,
          "vae": model,
          "attention": "Default",
          "vram_mode": "Default",
          "preview_interval": 1,
          "show_preview": "Medium",
          "network_mode": "Dynamic",
          "autocast": false,
          "tiling_mode": "Disabled",
        },
        "id": Math.floor(Math.random() * 1000000) + 1
      }

      id = request.id;

      switchWorking(true);
      await sendMessage(request);
    }

    $("#connect").on("click", async function () { await doConnect(); });

    $("#generate").on("click", async function () { await doGenerate(); });

    $("#forever").on("click", async function () {
      forever = !forever;
      if(forever) {
        $("#forever").addClass("btn-toggled");
      } else {
        $("#forever").removeClass("btn-toggled");
      }
    });

    $("#error-modal").on("hidden.bs.modal", function (e) {
      switchWorking(false);
      if(ws == undefined || ws.readyState != 1) {
        switchConnected(false)
      } else {
        switchConnected(true)
      }
    })

    $("#result").on("click", function () {
      if(results.length == 0) {
        return;
      }

      const options =  {
        dataSource: results,
        index: 0,
        loop: false,
        spacing: 0.1,
        zoom: false,
        clickToCloseNonZoomable: false,
        preload: [2, 2],
        showHideAnimationType: 'none',
      };
      gallery = new PhotoSwipe(options);

      gallery.on('uiRegister', function() {
        gallery.ui.registerElement({
          name: 'download-button',
          order: 8,
          isButton: true,
          tagName: 'a',

          html: {
            isCustomSVG: true,
            inner: '<path d="M20.5 14.3 17.1 18V10h-2.2v7.9l-3.4-3.6L10 16l6 6.1 6-6.1ZM23 23H9v2h14Z" id="pswp__icn-download"/>',
            outlineID: 'pswp__icn-download'
          },

          onInit: (el, pswp) => {
            el.setAttribute('download', '');
            el.setAttribute('target', '_blank');
            el.setAttribute('rel', 'noopener');

            pswp.on('change', () => {
              el.href = pswp.currSlide.data.src;
            });
          }
        });
      });

      gallery.on('destroy', () => {
        gallery = undefined
      });

      gallery.init();
    });

    $(document).ready(function() {
      const params = new URLSearchParams(window.location.search);
      const endpoint = params.get("endpoint");
      const password = params.get("password");
      if(password) {
        $("#password").val(password);
      }
      if(endpoint) {
        $("#endpoint").val(endpoint);
        doConnect();
      }
    });
  </script>
</html>